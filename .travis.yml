language: python

matrix:
  include:
    - python: 2.7
    - python: 3.5
    - python: 3.6
    - python: 3.7
    - python: 3.8
    - python: pypy
      env: OPTIONAL=1

  allow_failures:
    - env: OPTIONAL=1

addons:
  mariadb: 10.3

before_install:
- wget -t 3 -w 60 --random-wait https://github.com/DiamondLightSource/ispyb-database/releases/download/v1.15.2/ispyb-database-1.15.2.tar.gz
- tar xvfz ispyb-database-1.15.2.tar.gz
- mysql_upgrade -u root
- mysql -u root -e "CREATE DATABASE ispybtest; SET GLOBAL log_bin_trust_function_creators=ON;"
- mysql -u root -D ispybtest < schema/tables.sql
- mysql -u root -D ispybtest < schema/lookups.sql
- mysql -u root -D ispybtest < schema/data.sql
- mysql -u root -D ispybtest < schema/routines.sql
- mysql -u root -D ispybtest < grants/ispyb_processing.sql
- mysql -u root -D ispybtest < grants/ispyb_import.sql
- mysql -u root -e "CREATE USER ispyb_api@'localhost' IDENTIFIED BY 'password_1234'; GRANT ispyb_processing to ispyb_api@'localhost'; GRANT ispyb_import to ispyb_api@'localhost'; SET DEFAULT ROLE ispyb_processing FOR ispyb_api@'localhost';"
- mysql -u root -e "CREATE USER ispyb_api_future@'localhost' IDENTIFIED BY 'password_4321'; GRANT SELECT ON ispybtest.* to ispyb_api_future@'localhost';"

before_script:
- cp conf/config.example.cfg conf/config.cfg
- cp conf/ws_config.example.cfg conf/ws_config.cfg

install:
- pip install .
- pip install coveralls

script:
- coverage run --source=ispyb setup.py test
- python -m compileall -q *

after_success: coveralls

# Assuming you have installed the travis-ci CLI tool, after you
# create the Github repo and add it to Travis, run the
# following command to finish PyPI deployment setup:
# $ travis encrypt --pro --add deploy.password -r DiamondLightSource/ispyb-api
deploy:
  provider: pypi
  distributions: sdist bdist_wheel
  user: mgerstel
  password:
    secure: ck9nBs0RWNGz07rYLV9CqVOb7y00F6aNHcvWKd7j7HZyS7kAXkUowaBMbHMSLndj9yj3YoQj9Nv9XgBn+CelyODpK3uSBRvzDXstEyZTus+MlgaJda7J55+QCMrWer5ZOSoPxoIM04duhCyCUw10Q7G+sPkTp4SJGJ5z8MoVhtcE2zJiWdSfJbU8CcTC64VEE3wB/19KiKDH5mfuMCp8xE1LP4pW7w6WEsj76O3NUbWyXzfEo9Ydeh1eISP++ATyPI5pZCMOySUhT7BE6THKb6NPS6ItxRcbR12Qun4MTaySVoOyb+Q8s9H6WmLDHj8uoN7zmwrks0Tl1bPIctl+xa4S2GzKAqGlVjkH+SYOEn30+iI79C5FBT6ljTEr+Vkob0UwlTf/50TKF1UCJThiqagvxdb0+L2+1OEmLDzXMGJyGC04IeMYwF//5QZ7mHzdRugmBGAeHo7utwCn7MlmoMgHWCP7ES53YZFHfR0nDO5lOzk6awvS6Aa8zyGw35InFjem3EeF0MM07n0qfSh7EF59uhj4fcKeM+UWbhb09jIMW7Xz2dytgDgSNz24agS6G7uFbEnoJ3s4yVC4bZBPae5tiQxMsAWUeo1m/4bXU7dfRGFDP4nlrQ6yZq4H9GbYIYesEA7ol3WhJNdRBJMpu4xUtylHzhER8Q68FMy4EhI=
  on:
    tags: true
    repo: DiamondLightSource/ispyb-api
    python: 3.8
